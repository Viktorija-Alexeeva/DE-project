id: download-kaggle-to-gcs
namespace: de-project

tasks:
  - id: download-dataset
    type: io.kestra.plugin.scripts.python.Script
    inputFiles:
      kaggle_download.py: |
        import os
        from kaggle.api.kaggle_api_extended import KaggleApi

        # Set up Kaggle API credentials
        os.environ['KAGGLE_CONFIG_DIR'] = '/.kaggle'

        # Retrieve Kaggle username from KV store
        kaggle_username = "{{ vars.KAGGLE_USERNAME }}"
        
        api = KaggleApi()
        api.authenticate()

        # Download dataset
        dataset = "thedevastator/airbnb-prices-in-european-cities"
        api.dataset_download_files(dataset, path="/app/dataset", unzip=True)
    runner: DOCKER
    image: python:3.9
    commands:
      - pip install kaggle
      - python /app/kaggle_download.py

  - id: upload-to-gcs
    type: io.kestra.plugin.gcp.gcs.Upload
    bucket: "{{ vars.GCP_BUCKET_NAME }}"
    from: "kestra://download-dataset/dataset/"
    to: "raw/"
    
